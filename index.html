<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-6 md:p-12">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-4xl font-black tracking-tight text-white uppercase italic">System Health</h1>
                <p class="text-slate-400 mt-1">Automated Vendor Monitoring</p>
            </div>
            <div class="flex flex-col items-end">
                <button onclick="fetchAllData()" id="refresh-btn" class="mb-2 bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 text-sm">
                    <span id="refresh-icon">ðŸ”„</span> Sync Data
                </button>
                <div id="last-update" class="text-xs font-mono text-slate-500">Initializing...</div>
            </div>
        </header>
        
        <div id="status-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-12">
            </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <section class="md:col-span-2">
                <h2 class="text-sm font-black mb-4 text-slate-500 uppercase tracking-widest">Incident History</h2>
                <div id="history-container" class="bg-slate-900 border border-slate-800 rounded-2xl divide-y divide-slate-800 overflow-hidden text-sm">
                    </div>
            </section>

            <aside>
                <h2 class="text-sm font-black mb-4 text-slate-500 uppercase tracking-widest">Resources</h2>
                <div class="space-y-3">
                    <a href="https://health.aws.amazon.com/" target="_blank" class="block p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-amber-500/50 transition-colors">
                        <span class="font-bold text-slate-300">AWS Health</span>
                        <p class="text-[10px] text-slate-500 mt-1">Regional Dashboard</p>
                    </a>
                    <a href="https://www.cloudflarestatus.com/" target="_blank" class="block p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-orange-500/50 transition-colors">
                        <span class="font-bold text-slate-300">Cloudflare</span>
                        <p class="text-[10px] text-slate-500 mt-1">Edge Network Status</p>
                    </a>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const vendors = [
    { name: "Slack", key: "slack", type: "statuspage" },
    { name: "HubSpot", key: "hubspot", type: "statuspage" },
    { name: "Asana", key: "asana", type: "statuspage" },
    { name: "Zoom", key: "zoom", type: "statuspage" },
    { name: "Google Cloud", key: "google", type: "google" }
];

async function fetchAllData() {
    const btn = document.getElementById('refresh-btn');
    const icon = document.getElementById('refresh-icon');
    btn.disabled = true;
    icon.classList.add('loading-spin');

    try {
        // Fetch your generated file (cache-busting with timestamp)
        const response = await fetch('./data.json?t=' + new Date().getTime());
        const allData = await response.json();
        
        // This is the "map" function that connects your list to the JSON data
        const results = vendors.map(v => {
            const data = allData[v.key];
            let result = { name: v.name, status: "Unknown", color: "slate", incidents: [] };

            // Handle Statuspage.io vendors (Slack, HubSpot, Asana, Zoom)
            if (v.type === "statuspage" && data && data.status) {
                result.status = data.status.description;
                const ind = data.status.indicator;
                result.color = ind === "none" ? "emerald" : (ind === "minor" ? "amber" : "rose");
                
                // Fetching the incidents (resolved or active)
                result.incidents = (data.incidents || []).slice(0, 2).map(i => ({
                    title: i.name,
                    date: new Date(i.created_at).toLocaleDateString(),
                    vendor: v.name
                }));
            } 
            // Handle Google's specific array format
            else if (v.type === "google" && Array.isArray(data)) {
                const active = data.filter(i => !i.resolved);
                result.status = active.length === 0 ? "Operational" : "Incident";
                result.color = active.length === 0 ? "emerald" : "rose";
                
                result.incidents = data.slice(0, 2).map(i => ({
                    title: i.external_desc || "Maintenance/Issue",
                    date: i.begin ? i.begin.split('T')[0] : 'Recent', 
                    vendor: v.name
                }));
            }
            return result;
        });

        renderDashboard(results);
    } catch (err) {
        console.error("Dashboard failed to load data:", err);
        document.getElementById('status-container').innerHTML = `<p class="text-rose-500 font-mono text-xs">Error: data.json not ready or invalid. Run GitHub Action first.</p>`;
    } finally {
        btn.disabled = false;
        icon.classList.remove('loading-spin');
        document.getElementById('last-update').innerText = `Sync: ${new Date().toLocaleTimeString()}`;
    }
}

function renderDashboard(results) {
    const statusContainer = document.getElementById('status-container');
    const historyContainer = document.getElementById('history-container');

    // Render the top grid cards
    statusContainer.innerHTML = results.map(res => `
        <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl flex flex-col gap-3">
            <span class="text-xs font-black uppercase text-slate-500 tracking-widest">${res.name}</span>
            <div class="flex items-center">
                <span class="h-2.5 w-2.5 rounded-full bg-${res.color}-500 mr-2"></span>
                <span class="text-${res.color}-400 font-mono text-[10px] font-bold uppercase tracking-widest">${res.status}</span>
            </div>
        </div>
    `).join('');

    // Flatten all incidents into one list and show them
    const allIncidents = results.flatMap(r => r.incidents);
    
    if (allIncidents.length > 0) {
        historyContainer.innerHTML = allIncidents.map(inc => `
            <div class="p-4 hover:bg-slate-800/30 transition-colors">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-bold text-blue-400 uppercase">${inc.vendor}</span>
                    <span class="text-[10px] font-mono text-slate-600">${inc.date}</span>
                </div>
                <p class="text-slate-300 font-medium text-sm">${inc.title}</p>
            </div>
        `).join('');
    } else {
        historyContainer.innerHTML = `<div class="p-8 text-center text-slate-700 italic">No recent incidents recorded.</div>`;
    }
}

// Initial Call
fetchAllData();
    </script>
</body>
</html>
